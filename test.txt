#!/usr/bin/env python3

import homestat as t
import unittest


class TestStatistics(unittest.TestCase):
    def assertHasOrder(self, iterable, func=None):
        if func is None:
            func = lambda a, b: a <= b

        back = None
        for item in iterable:
            if back is not None:
                self.assertTrue(func(back, item))
            back = item

    def assertSubSequence(self, a, b):
        for i in a:
            self.assertIn(i, b)

    def setUp(self):
        self._stat = t.make_stat('home.html')
        self._cmp = lambda a, b: a[1] >= b[1]

    def testExtractYears(self):
        self.assertListEqual(
            t.extract_years(self._stat),
            list(map(str, range(2004, 2013))))

    def testExtractGeneral_CorrectOrder(self):
        self.assertHasOrder(
            t.extract_general(self._stat), func=self._cmp)

    def _check_type(self, item):
        self.assertIs(type(item), tuple)
        self.assertEqual(len(item), 2)
        self.assertIs(type(item[0]), str)
        self.assertIs(type(item[1]), int)

    def testExtractGeneral_CorrectType(self):
        for item in t.extract_general(self._stat):
            self._check_type(item)

    def testExtractMale_CorrectOrder(self):
        self.assertHasOrder(
            t.extract_general_male(self._stat), func=self._cmp)

    def testExtractMale_CorrectType(self):
        for item in t.extract_general_male(self._stat):
            self._check_type(item)

    def testExtractFemale_CorrectOrder(self):
        self.assertHasOrder(
            t.extract_general_female(self._stat), func=self._cmp)

    def testExtractFemale_CorrectType(self):
        for item in t.extract_general_female(self._stat):
            self._check_type(item)

    def testExtractYear_CorrectOrder(self):
        for year in t.extract_years(self._stat):
            self.assertHasOrder(
                t.extract_year(self._stat, year), func=self._cmp)

    def testExtractYear_CorrectType(self):
        for year in t.extract_years(self._stat):
            for item in t.extract_year(self._stat, year):
                self._check_type(item)

    def testExtractYearMale_CorrectOrder(self):
        for year in t.extract_years(self._stat):
            self.assertHasOrder(
                t.extract_year_male(self._stat, year), func=self._cmp)

    def testExtractYearMale_CorrectType(self):
        for year in t.extract_years(self._stat):
            for item in t.extract_year_male(self._stat, year):
                self._check_type(item)

    def testExtractYearFemale_CorrectOrder(self):
        for year in t.extract_years(self._stat):
            self.assertHasOrder(
                t.extract_year_female(self._stat, year), func=self._cmp)

    def testExtractYearFemale_CorrectType(self):
        for year in t.extract_years(self._stat):
            for item in t.extract_year_female(self._stat, year):
                self._check_type(item)

    def testGeneralEqualsMalePlusFemale(self):
        alls = t.extract_general(self._stat)
        males = t.extract_general_male(self._stat)
        females = t.extract_general_female(self._stat)

        self.assertEqual(len(alls), len(males) + len(females))
        self.assertSubSequence(males, alls)
        self.assertSubSequence(females, alls)

    def testYearEqualsMalePlusFemale(self):
        for year in t.extract_years(self._stat):
            alls = t.extract_year(self._stat, year)
            males = t.extract_year_male(self._stat, year)
            females = t.extract_year_female(self._stat, year)

            self.assertEqual(len(alls), len(males) + len(females))
            self.assertSubSequence(males, alls)
            self.assertSubSequence(females, alls)

    def testCorrectSex(self):
        self.assertSubSequence(
            (('–î–º–∏—Ç—Ä–∏–π', 36), ('–ò–ª—å—è', 19), ('–ò–≥–æ—Ä—å', 12), ('– –æ–º–∞–Ω', 8),
             ('–ö–∏—Ä–∏–ª–ª', 7), ('–ù–∏–∫–∏—Ç–∞', 5), ('–õ—ë–≤–∞', 1), ('–ê–ª–µ—Ö–∞–Ω–¥—Ä–æ', 1)),
            t.extract_general_male(self._stat))

        self.assertSubSequence(
            (('–ï–ª–µ–Ω–∞', 18), ('–ö—Å–µ–Ω–∏—è', 5), ('–õ—é–±–æ–≤—å', 2),
             ('–ê–ª—ë–Ω–∞', 2), ('–ï–ª–∏–∑–∞–≤–µ—Ç–∞', 1)),
            t.extract_general_female(self._stat))

    def testCorrectStat(self):
        self.assertSubSequence(
            (('–ê—Ä—Ç—ë–º', 1), ('–û–ª–µ–≥', 1), ('–ï–ª–µ–Ω–∞', 1), ('–ê–Ω–Ω–∞', 1)),
            t.extract_year(self._stat, '2004'))
        self.assertEqual(10, len(t.extract_year(self._stat, '2004')))

        self.assertSubSequence(
            (('–î–º–∏—Ç—Ä–∏–π', 5), ('–°–µ—Ä–≥–µ–π', 1), ('–ê–ª–µ–∫—Å–µ–π', 2),
             ('–ï–ª–µ–Ω–∞', 4), ('–ï–≤–≥–µ–Ω–∏—è', 1), ('–ù–∞—Ç–∞—à–∞', 1)),
            t.extract_year(self._stat, '2005'))
        self.assertEqual(31, len(t.extract_year(self._stat, '2005')))

        self.assertSubSequence(
            (('–ú–∏—Ö–∞–∏–ª', 3), ('–§—ë–¥–æ—Ä', 1), ('–ü–∞–≤–µ–ª', 5),
             ('–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞', 3), ('–ò—Ä–∏–Ω–∞', 1)),
            t.extract_year(self._stat, '2006'))
        self.assertEqual(38, len(t.extract_year(self._stat, '2006')))

        self.assertSubSequence(
            (('–ê–ª–µ–∫—Å–∞–Ω–¥—Ä', 6), ('–ê–Ω—Ç–æ–Ω', 2), ('–ú–∏—Ö–∞–∏–ª', 3), ('–ï–≥–æ—Ä', 1),
             ('–ö—Å–µ–Ω–∏—è', 3), ('–î–∞—Ä—å—è', 2), ('–Æ–ª–∏—è', 1)),
            t.extract_year(self._stat, '2007'))
        self.assertEqual(53, len(t.extract_year(self._stat, '2007')))

        self.assertSubSequence(
            (('–°–µ—Ä–≥–µ–π', 5), ('–ï–≤–≥–µ–Ω–∏–π', 2), ('–ê—Ä—Ç—É—Ä', 1), ('–ê–ª–µ—Ö–∞–Ω–¥—Ä–æ', 1),
             ('–ï–ª–µ–Ω–∞', 2), ('–ù–∞—Ç–∞–ª—å—è', 1), ('–õ–∏–¥–∏—è', 1)),
            t.extract_year(self._stat, '2008'))
        self.assertEqual(40, len(t.extract_year(self._stat, '2008')))

        self.assertSubSequence(
            (('–ù–∏–∫–∏—Ç–∞', 2), ('–ò–ª—å—è', 5), ('–õ–µ–æ–Ω–∏–¥', 1), ('–î–∞–Ω–∏–ª', 1),
             ('–ï–ª–µ–Ω–∞', 2), ('–ï–≤–≥–µ–Ω–∏—è', 1), ('–ï–ª–∏–∑–∞–≤–µ—Ç–∞', 1)),
            t.extract_year(self._stat, '2009'))
        self.assertEqual(40, len(t.extract_year(self._stat, '2009')))

        self.assertSubSequence(
            (('–ê–Ω–¥—Ä–µ–π', 4), ('–ò–≥–æ—Ä—å', 2), ('– –æ–±–µ—Ä—Ç', 1), ('–ë–æ—Ä–∏—Å', 1),
             ('–î–∞—Ä—å—è', 2), ('–õ–∏–ª–∏—è', 1), ('–ù–∞–¥–µ–∂–¥–∞', 1)),
            t.extract_year(self._stat, '2010'))
        self.assertEqual(41, len(t.extract_year(self._stat, '2010')))

        self.assertSubSequence(
            (('–ê–Ω—Ç–æ–Ω', 3), ('–ì—Ä–∏–≥–æ—Ä–∏–π', 1), ('–ì–µ–æ—Ä–≥–∏–π', 1),
             ('–ò—Ä–∏–Ω–∞', 4), ('–í–∞–ª–µ—Ä–∏—è', 1), ('–ú–∞—Ä–∏–Ω–∞', 1), ('–õ—é–±–æ–≤—å', 1)),
            t.extract_year(self._stat, '2011'))
        self.assertEqual(43, len(t.extract_year(self._stat, '2011')))

        self.assertSubSequence(
            (('–î–º–∏—Ç—Ä–∏–π', 6), ('–û–ª–µ–≥', 2), ('–õ—ë–≤–∞', 1), ('–î–∞–Ω–∏–∏–ª', 1),
             ('–¢–∞—Ç—å—è–Ω–∞', 3), ('–ú–∞—Ä–∏—è', 2), ('–ê–ª–∏—Å–∞', 1)),
            t.extract_year(self._stat, '2012'))
        self.assertEqual(44, len(t.extract_year(self._stat, '2012')))


if __name__ == '__main__':
    unittest.main()